# ============================================================================
# DOCKER COMPOSE - PRODUÇÃO - MICROSERVIÇO AUTENTICAÇÃO
# ============================================================================
# Configuração simplificada para produção sem MySQL próprio
# Conecta ao MySQL existente no servidor
# ============================================================================

services:
  autenticacao:
    image: ghcr.io/wibson82/conexao-de-sorte-backend-autenticacao:${IMAGE_TAG:-latest}
    environment:
      - SPRING_PROFILES_ACTIVE=${ENVIRONMENT:-prod,azure}
      - TZ=America/Sao_Paulo
      - SERVER_PORT=8080

      # Database Configuration - MySQL Externo
      - SPRING_R2DBC_URL=${DATABASE_R2DBC_URL}
      - SPRING_R2DBC_USERNAME=${DATABASE_USERNAME}
      - SPRING_R2DBC_PASSWORD=${DATABASE_PASSWORD}
      - SPRING_FLYWAY_URL=${DATABASE_JDBC_URL}
      - SPRING_FLYWAY_USER=${DATABASE_USERNAME}
      - SPRING_FLYWAY_PASSWORD=${DATABASE_PASSWORD}

      # Redis Configuration - Redis Externo
      - SPRING_DATA_REDIS_HOST=${REDIS_HOST}
      - SPRING_DATA_REDIS_PORT=${REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${REDIS_PASSWORD}
      - SPRING_DATA_REDIS_DATABASE=${REDIS_DATABASE:-1}

      # JWT Configuration
      - JWT_ISSUER=${JWT_ISSUER:-https://auth.conexaodesorte.com.br}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_KEY_ID=${JWT_KEY_ID:-auth-key}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-RS256}
      - JWT_ACCESS_TOKEN_VALIDITY=${JWT_ACCESS_TOKEN_VALIDITY:-86400}
      - JWT_REFRESH_TOKEN_VALIDITY=${JWT_REFRESH_TOKEN_VALIDITY:-604800}

      # CORS Configuration
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-https://conexaodesorte.com.br}
      - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS:-true}

      # Azure Key Vault
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_KEYVAULT_ENDPOINT=${AZURE_KEYVAULT_ENDPOINT}
      - AZURE_KEYVAULT_ENABLED=${AZURE_KEYVAULT_ENABLED:-true}

      # Feature Flags
      - FEATURE_AUTH_MICROSERVICE=${FEATURE_AUTH_MICROSERVICE:-true}
      - FEATURE_JWKS_ROTATION=${FEATURE_JWKS_ROTATION:-true}
      - FEATURE_AUDIT_LOGGING=${FEATURE_AUDIT_LOGGING:-true}
      - FEATURE_METRICS_COLLECTION=${FEATURE_METRICS_COLLECTION:-true}

      # Rate Limiting
      - RATE_LIMIT_LOGIN=${RATE_LIMIT_LOGIN:-10}
      - RATE_LIMIT_LOGIN_BURST=${RATE_LIMIT_LOGIN_BURST:-20}
      - RATE_LIMIT_VALIDATION=${RATE_LIMIT_VALIDATION:-100}
      - RATE_LIMIT_VALIDATION_BURST=${RATE_LIMIT_VALIDATION_BURST:-200}

      # Logging
      - LOG_LEVEL_ROOT=${LOG_LEVEL_ROOT:-INFO}
      - LOG_LEVEL_AUTENTICACAO=${LOG_LEVEL_AUTENTICACAO:-INFO}
      - LOG_LEVEL_SECURITY=${LOG_LEVEL_SECURITY:-WARN}

      # Tracing
      - TRACING_PROBABILITY=${TRACING_PROBABILITY:-0.1}

    networks:
      - conexao-network-swarm

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

networks:
  conexao-network-swarm:
    external: true

# ============================================================================
# NOTAS IMPORTANTES:
# ============================================================================
#
# 1. Este arquivo NÃO cria instâncias próprias de MySQL ou Redis
# 2. Conecta aos serviços existentes no servidor via variáveis de ambiente
# 3. Para desenvolvimento local, use docker-compose.dev.yml
# 4. As variáveis de ambiente devem ser definidas no arquivo .env ou CI/CD
#
# Variáveis obrigatórias:
# - DATABASE_R2DBC_URL=r2dbc:mysql://mysql-host:3306/conexao_auth
# - DATABASE_JDBC_URL=jdbc:mysql://mysql-host:3306/conexao_auth
# - DATABASE_USERNAME=usuario_auth
# - DATABASE_PASSWORD=senha_segura
# - REDIS_HOST=redis-host
# - REDIS_PASSWORD=senha_redis
# - JWT_SECRET=chave_jwt_secreta
# - AZURE_CLIENT_ID=client_id_azure
# - AZURE_TENANT_ID=tenant_id_azure
# - AZURE_KEYVAULT_ENDPOINT=https://keyvault.vault.azure.net/
#
# ============================================================================
